@using SMEapps.Shared.Model
@using SMEapps.Shared.Services
<div class="navmenu">
    <input type="checkbox" title="Menu expand/collapse toggle" id="navmenu-toggle" class="navmenu-icon" />
    <label for="navmenu-toggle" class="navmenu-icon"></label>
    <nav class="sitenav" aria-labelledby="main-menu">

    </nav>
</div>

@code {
    [Inject] private DashboardService DashboardService { get; set; } = default!;
    [Inject] private ISStore SStore { get; set; } = default!;

    private bool expanded = true;
    private bool isLoaded = false;
    private List<ModuleWithFeatures>? modules;

    // Track expanded modules by a key (module name). Use a HashSet for O(1) checks.
    private readonly HashSet<string> expandedModules = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return; 
      
        string? roleName = null;
        roleName = await SStore.GetAsync<string>("roleName");
        


        if (string.IsNullOrWhiteSpace(roleName))
        {
            isLoaded = true;
            StateHasChanged();
            return;
        }

        try
        {
            modules = await DashboardService.GetModulesByRoleNameAsync(roleName);
        }
        catch
        {
            modules = new List<ModuleWithFeatures>();
        }
        finally
        {
            isLoaded = true;
            StateHasChanged();
        }
    }

    private void ToggleModule(string moduleKey)
    {
        if (string.IsNullOrWhiteSpace(moduleKey))
            return;

        if (expandedModules.Contains(moduleKey))
            expandedModules.Remove(moduleKey);
        else
            expandedModules.Add(moduleKey);

        StateHasChanged();
    }

    private bool IsModuleExpanded(string moduleKey) => !string.IsNullOrWhiteSpace(moduleKey) && expandedModules.Contains(moduleKey);
}
