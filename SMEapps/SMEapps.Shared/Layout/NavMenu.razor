@using SMEapps.Shared.Model
@using SMEapps.Shared.Services
<MudPaper Width="250px" Elevation="0" Class="py-3">
    <MudNavMenu Bordered="true">

        @if(!isLoaded || modules == null){
        }
        else{
        @foreach (var module in modules.OrderBy(m => m.MenuPosition))
        {
            var moduleKey = string.IsNullOrWhiteSpace(module?.Name) ? module?.Url ?? Guid.NewGuid().ToString() : module.Name!;
            EnsureModuleKey(moduleKey);

            if (module?.Features != null && module.Features.Count > 0)
            {
                <MudNavGroup Title="@module.Name" Icon="@module.Icon" @bind-Expanded="moduleExpanded[moduleKey]">
                  
                    @foreach (var feature in module.Features.OrderBy(f => f.OrderNo))
                    {
                        if (!string.IsNullOrWhiteSpace(feature.Path))
                        {
                            <MudNavLink Href="@feature.Path">@feature.FeatureName</MudNavLink>
                        }
                        else
                        {
                                <MudNavLink>@feature.FeatureName</MudNavLink>
                        }
                    }
                </MudNavGroup>
            }
            else
            {
                    <MudNavLink Href="@module.Url" Icon="fas fa-home">@module.Name</MudNavLink>
            }
        }

        }

       

    </MudNavMenu>
</MudPaper>

@code {
    [Inject] private DashboardService DashboardService { get; set; } = default!;
    [Inject] private ISStore SStore { get; set; } = default!;

    private bool expanded = true;
    private bool isLoaded = false;
    private List<ModuleWithFeatures>? modules;

    // Track expanded modules by a key (module name). Use a dictionary for two-way binding with MudNavGroup.
    private readonly Dictionary<string, bool> moduleExpanded = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        string? roleName = null;
        roleName = await SStore.GetAsync<string>("roleName");


        if (string.IsNullOrWhiteSpace(roleName))
        {
            isLoaded = true;
            StateHasChanged();
            return;
        }

        try
        {
            modules = await DashboardService.GetModulesByRoleNameAsync(roleName);

            // Initialize expanded dictionary for modules that have features
            if (modules != null)
            {
                foreach (var m in modules)
                {
                    var key = string.IsNullOrWhiteSpace(m?.Name) ? m?.Url ?? Guid.NewGuid().ToString() : m!.Name!;
                    if (!moduleExpanded.ContainsKey(key))
                        moduleExpanded[key] = false;
                }
            }
        }
        catch
        {
            modules = new List<ModuleWithFeatures>();
        }
        finally
        {
            isLoaded = true;
            StateHasChanged();
        }
    }

    private void ToggleModule(string moduleKey)
    {
        if (string.IsNullOrWhiteSpace(moduleKey))
            return;

        if (moduleExpanded.ContainsKey(moduleKey))
            moduleExpanded[moduleKey] = !moduleExpanded[moduleKey];
        else
            moduleExpanded[moduleKey] = true;

        StateHasChanged();
    }

    private bool IsModuleExpanded(string moduleKey) => !string.IsNullOrWhiteSpace(moduleKey) && moduleExpanded.ContainsKey(moduleKey) && moduleExpanded[moduleKey];

    private void EnsureModuleKey(string key)
    {
        if (string.IsNullOrWhiteSpace(key))
            return;
        if (!moduleExpanded.ContainsKey(key))
            moduleExpanded[key] = false;
    }
}
