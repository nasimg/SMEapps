@using SMEapps.Shared.Model
@using SMEapps.Shared.Services
<MudPaper Width="250px" Elevation="0" Class="py-3">
    <MudNavMenu Bordered="true">
        <MudNavLink Href="/dashboard">Dashboard</MudNavLink>
        <MudNavLink Match="NavLinkMatch.Prefix" Href="/components/navmenu">Servers</MudNavLink>
        <MudNavLink Href="/billing" Disabled="true">Billing</MudNavLink>
        <MudNavGroup Title="Settings" Expanded="true">
            <MudNavLink Href="/person-info">Person Info</MudNavLink>
            <MudNavLink Href="/security">Security</MudNavLink>
        </MudNavGroup>
        <MudNavLink Href="/about">About</MudNavLink>
    </MudNavMenu>
</MudPaper>

@code {
    [Inject] private DashboardService DashboardService { get; set; } = default!;
    [Inject] private ISStore SStore { get; set; } = default!;

    private bool expanded = true;
    private bool isLoaded = false;
    private List<ModuleWithFeatures>? modules;

    // Track expanded modules by a key (module name). Use a HashSet for O(1) checks.
    private readonly HashSet<string> expandedModules = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return; 
      
        string? roleName = null;
        roleName = await SStore.GetAsync<string>("roleName");
        


        if (string.IsNullOrWhiteSpace(roleName))
        {
            isLoaded = true;
            StateHasChanged();
            return;
        }

        try
        {
            modules = await DashboardService.GetModulesByRoleNameAsync(roleName);
        }
        catch
        {
            modules = new List<ModuleWithFeatures>();
        }
        finally
        {
            isLoaded = true;
            StateHasChanged();
        }
    }

    private void ToggleModule(string moduleKey)
    {
        if (string.IsNullOrWhiteSpace(moduleKey))
            return;

        if (expandedModules.Contains(moduleKey))
            expandedModules.Remove(moduleKey);
        else
            expandedModules.Add(moduleKey);

        StateHasChanged();
    }

    private bool IsModuleExpanded(string moduleKey) => !string.IsNullOrWhiteSpace(moduleKey) && expandedModules.Contains(moduleKey);
}
