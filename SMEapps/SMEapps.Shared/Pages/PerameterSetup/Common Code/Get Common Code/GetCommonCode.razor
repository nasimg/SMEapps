@page "/commoncode"
@using SMEapps.Shared.Services
@inject CommonCodeService _service
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
    <MudPaper Class="pa-6">
        <MudStack Row Class="mb-4 d-flex justify-space-between align-center">
            <MudText Typo="Typo.h5">📋 Common Code List</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GoToAdd">
                ➕ Add Common Code
            </MudButton>
        </MudStack>

        <MudTable Items="_codes" Dense="true" Hover="true" Bordered="true" Elevation="1" Loading="_loading">
            <HeaderContent>
                <MudTh>Code Type</MudTh>
                <MudTh>Code Value</MudTh>
                <MudTh>Parent Id</MudTh>
                <MudTh>Status</MudTh>
                @* <MudTh><MudTh></MudTh> *@
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Code Type">@context.CodeType</MudTd>
                <MudTd DataLabel="Code Value">@context.CodeValue</MudTd>
                <MudTd DataLabel="Parent Id">@context.ParentId</MudTd>
                @* <MudTd DataLabel="Status">
                    <MudSwitch @bind-Checked="@context.Status" 
                               Color="Color.Primary" 
                               Disabled="_loading" />

                </MudTd> *@

                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => Edit(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No codes found. <MudLink Href="/commoncode/add">Add one?</MudLink></MudText>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<CommonCode> _codes = new();
    private bool _loading;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            _codes = await _service.GetAllAsync() ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading codes: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void GoToAdd() => NavManager.NavigateTo("/commoncode/add");

    private void Edit(CommonCode code)
    {
        NavManager.NavigateTo($"/commoncode/edit/{code.CommonCodeId}");
    }

    private async Task OnStatusChanged(ChangeEventArgs e, CommonCode code)
    {
        // Safely convert e.Value (object?) to bool
        if (e.Value is bool newStatus)
        {
            var originalStatus = code.Status; // Save original
            code.Status = newStatus;

            var result = await _service.SaveAsync(code);

            if (result.StatusCode != 200)
            {
                code.Status = originalStatus; // Revert on failure
                Snackbar.Add(result.Message ?? "Failed to update status", Severity.Error);
                StateHasChanged();
            }
        }
    }
}