@page "/counter"

<PageTitle>Counter</PageTitle>

@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthProvider
@inject NavigationManager NavigationManager

@if (!isChecked)
{
    <p>Checking authentication...</p>
}
else
{
    <h1>Counter</h1>

    <div role="status" style="padding-bottom: 1em;">
        Current count: <FluentBadge Appearance="Appearance.Neutral">@currentCount</FluentBadge>
    </div>

    <FluentButton Appearance="Appearance.Accent" @onclick="IncrementCount">Click me</FluentButton>
}

@code {
    private int currentCount = 0;
    private bool isChecked = false;

    // Defer authentication checks until after first render to avoid static prerender causing JS/localStorage to be unavailable.
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user?.Identity == null || !user.Identity.IsAuthenticated)
        {
            var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
            var returnUrl = "/" + (string.IsNullOrEmpty(relativePath) ? "" : relativePath);
            NavigationManager.NavigateTo($"/identity/login?returnUrl={Uri.EscapeDataString(returnUrl)}");
            return;
        }

        isChecked = true;
        StateHasChanged();
    }

    private void IncrementCount()
    {
        currentCount++;
    }
}
