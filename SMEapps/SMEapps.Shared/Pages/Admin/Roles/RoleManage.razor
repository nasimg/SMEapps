@page "/role-features"
@inject IHttpClientFactory HttpFactory
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">

    <!-- ROLE DROPDOWN -->
    <MudSelect T="string" Label="Select Role" @bind-Value="SelectedRoleId"
               Variant="Variant.Outlined" Dense="true" Style="width:300px">
        @foreach (var r in Roles)
        {
            <MudSelectItem Value="@r.Name">@r.Name</MudSelectItem>
        }
    </MudSelect>

    <!-- MODULE DROPDOWN -->
    <MudSelect T="int" Label="Select Module" @bind-Value="SelectedModuleId"
               Variant="Variant.Outlined" Dense="true" Style="width:300px" Class="mt-3">
        @foreach (var m in Modules)
        {
            <MudSelectItem Value="@m.ModuleId">@m.Title</MudSelectItem>
        }
    </MudSelect>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-3"
               OnClick="LoadFeatures"
               Disabled="@(!CanLoad)">
        Load Features
    </MudButton>

    <MudDivider Class="my-4" />

    @if (Features?.Count > 0)
    {
        <MudTable Items="Features" Hover="true" Bordered="true">
            <HeaderContent>
                <MudTh>Feature</MudTh>
                <MudTh>Path</MudTh>
                <MudTh>Active</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>@context.FeatureName</MudTd>
                <MudTd>@context.Path</MudTd>
                <MudTd>@context.IsActive</MudTd>
            </RowTemplate>
        </MudTable>
    }

</MudPaper>

@code {

    HttpClient Http;

    // ------------ ROLE VM ------------
    public class RoleDropdownVm
    {
        public string Id { get; set; }
        public string Name { get; set; }
    }

    // ------------ MODULE VM ------------
    public class ModuleVm
    {
        public int ModuleId { get; set; }
        public string Title { get; set; }
    }

    // ----------- USED FOR API RESPONSE -----------
    public class ModuleWithFeatures
    {
        public string Name { get; set; }
        public string Url { get; set; }
        public string Icon { get; set; }
        public int? MenuPosition { get; set; }
        public List<FeatureVm> Features { get; set; }
    }

    public class FeatureVm
    {
        public int FeatureId { get; set; }
        public int ModuleId { get; set; }
        public string FeatureName { get; set; }
        public string Path { get; set; }
        public bool IsActive { get; set; }
    }

    List<RoleDropdownVm> Roles = new();
    List<ModuleVm> Modules = new();
    List<FeatureVm> Features = new();

    // ------------ SELECTED VALUES ------------
    string SelectedRoleId;
    int SelectedModuleId;

    bool CanLoad => !string.IsNullOrWhiteSpace(SelectedRoleId) && SelectedModuleId > 0;

    // ------------ INITIALIZATION ------------
    protected override async Task OnInitializedAsync()
    {
        Http = HttpFactory.CreateClient("ApiClient");
        await LoadRoles();
        await LoadModules();
    }

    // ------------ LOAD ROLES ------------
    async Task LoadRoles()
    {
        try
        {
            Roles = await Http.GetFromJsonAsync<List<RoleDropdownVm>>("/Identity/GetRoles");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Snackbar.Add("Error loading roles", Severity.Error);
        }
    }

    // ------------ LOAD MODULES ------------
    async Task LoadModules()
    {
        try
        {
            Modules = await Http.GetFromJsonAsync<List<ModuleVm>>("/sme/api/Module/GetAll");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Snackbar.Add("Error loading modules", Severity.Error);
        }
    }

    // ------------ LOAD FEATURES ------------
    async Task LoadFeatures()
    {
        try
        {
            // 1. Load modules + features for selected ROLE
            var roleModules = await Http.GetFromJsonAsync<List<ModuleWithFeatures>>(
                $"/sme/api/RoleFeature/GetModulesByRoleName/modules/{SelectedRoleId}"
            );

            // 2. Filter by selected module
            var selectedModule = roleModules?.FirstOrDefault(x => x.Features.Any(f => f.ModuleId == SelectedModuleId));

            Features = selectedModule?.Features
                       ?.Where(f => f.ModuleId == SelectedModuleId)
                       .ToList()
                       ?? new();

            if (Features.Count == 0)
                Snackbar.Add("No features found!", Severity.Warning);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Snackbar.Add("Error loading features", Severity.Error);
        }
    }
}
